{% extends 'layout.html' %}
{% block content %}
  <h1>Auto Scan</h1>
  <form method="post" enctype="multipart/form-data" class="mb-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="file" name="statement" multiple required>
    <button class="btn btn-primary" type="submit">Scan</button>
  </form>
  {% if results %}
  <h2>Recurring Expenses</h2>
  <form method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <table class="table table-bordered">
    <thead>
      <tr><th></th><th>Description</th><th>Amount</th></tr>
    </thead>
    <tbody>
    {% for desc, amt in results %}
      <tr>
        <td class="text-center">
          <input type="checkbox" name="add_{{ loop.index0 }}" class="form-check-input shadow-sm" checked>
          <input type="hidden" name="desc_{{ loop.index0 }}" value="{{ desc }}">
          <input type="hidden" name="amt_{{ loop.index0 }}" value="{{ amt }}">
        </td>
        <td>{{ desc }}</td>
        <td>{{ amt|fmt }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  <button class="btn btn-primary" type="submit">Save</button>
  </form>
  {% else %}
    <p>No recurring expenses found.</p>
  {% endif %}
  <h2 class="mt-4">Saved Monthly Expenses</h2>
  <table class="table table-bordered">
    <thead>
      <tr><th>Description</th><th>Amount</th><th></th></tr>
    </thead>
    <tbody>
    {% for desc, amt in monthly_expenses %}
      <tr>
        <td>{{ desc }}</td>
        <td>{{ amt|fmt }}</td>
        <td>
          <form method="post" action="{{ url_for('delete_monthly_expense_route', desc=desc) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-sm btn-danger">Delete</button>
          </form>
        </td>
      </tr>
    {% else %}
      <tr><td colspan="3">No monthly expenses saved.</td></tr>
    {% endfor %}
    </tbody>
  </table>

  <h2 class="mt-4">
    One Time Expenses (Total {{ one_time_total|fmt }})
    <button id="edit-one-time" class="btn btn-sm btn-secondary ms-2">Edit</button>
  </h2>
  <form method="post" action="{{ url_for('delete_one_time_route') }}" id="one-time-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  </form>
  <table class="table table-bordered" id="one-time-table">
    <thead>
      <tr><th class="edit-col d-none"></th><th>Description</th><th>Amount</th><th>Date</th><th class="edit-col d-none"></th></tr>
    </thead>
    <tbody>
    {% for e in one_time_expenses %}
      <tr>
        <td class="edit-col d-none text-center">
          <input type="checkbox" form="one-time-form" name="delete" value="{{ e[0] }}" class="form-check-input">
        </td>
        <td>{{ e[1] }}</td>
        <td>{{ e[2]|fmt }}</td>
        <td>{{ e[3][:10] }}</td>
        <td class="edit-col d-none">
          <form method="post" action="{{ url_for('convert_one_time_expense', oid=e[0]) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-sm btn-primary">Make Monthly</button>
          </form>
        </td>
      </tr>
    {% else %}
      <tr><td colspan="5">No one time expenses</td></tr>
    {% endfor %}
    </tbody>
  </table>
  <div class="text-end edit-col d-none mb-3">
    <button class="btn btn-danger" form="one-time-form">Delete</button>
  </div>
  <script>
  document.getElementById('edit-one-time').addEventListener('click', () => {
    document.querySelectorAll('.edit-col').forEach(el => el.classList.toggle('d-none'));
  });
  </script>
</div>
{% endblock %}
